<!-- test.html -->
<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Custom Module Test</title>
    <!-- Tailwind CDN and font config -->
    <script>
        tailwind.config = {
            theme: {
                extend: {
                    fontFamily: {
                        sans: ['Inter', 'sans-serif'],
                    },
                },
            },
        }
    </script>
    <script src="https://cdn.tailwindcss.com"></script>
    <!-- Font -->
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@100..900&display=swap" rel="stylesheet">
    <!-- Font Awesome -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0-beta3/css/all.min.css">
    <style>
        .custom-shadow {
            box-shadow: 0px 4px 4px 0px #00000040;
        }

        .font {
            font-family: "Inter", sans-serif;
        }

        .content {
            width: 95%;
            transition: width 0.3s ease;
        }

        .sidebar {
            width: 5%;
            transition: width 0.3s ease;
            overflow: hidden;
            position: relative;
            display: flex;
            align-items: center;
            background-color: #0EC1DD;
            padding: 0 0.5rem;
        }

        .sidebar-expanded {
            align-items: flex-start;
            background-color: white;
            transition: width 0.3s ease;
            /* Smooth transition for width change */
        }

        @media (min-width: 1024px) {

            /* Large screens */
            .sidebar-expanded {
                width: 20%;
                /* 20% width on larger screens */
            }

            .content-expanded {
                width: 80%;
            }

        }

        @media (min-width: 768px) and (max-width: 1023px) {

            /* Medium screens */
            .sidebar-expanded {
                width: 30%;
                /* 30% width on medium screens */
            }

            .content-expanded {
                width: 70%;
            }

        }

        @media (max-width: 767px) {

            /* Small screens */
            .sidebar-expanded {
                width: 80%;
                /* Occupy almost the full screen on small screens */
            }

            .content-expanded {
                width: 20%;
            }

        }

        .hidden-content {
            display: none;
        }

        .hidden-content.show {
            display: block;
        }

        .toggle-icon {
            color: white;
            position: absolute;
            transition: top 0.3s ease, transform 0.3s ease;
        }

        .sidebar .toggle-icon {
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
        }

        .sidebar-expanded .toggle-icon {
            top: 18px;
            left: auto;
            right: 10px;
            transform: translate(0, 0);
        }

        .legend {
            display: flex;
            align-items: center;
            margin-top: 10px;
        }

        .legend-color {
            width: 20px;
            height: 20px;
            margin-right: 10px;
            border-radius: 20%;
        }

        .question-container {
            display: flex;
            justify-content: center;
            align-items: center;
        }

        .question-status {
            width: 15px;
            height: 15px;
            display: flex;
            justify-content: center;
            align-items: center;
            border: 1px solid #ccc;
            border-radius: 20%;
        }

        .answered {
            background-color: #28A745;
        }

        .not_answered {
            background-color: #DC3545;
        }

        .marked_for_review {
            background-color: #FFC107;
        }

        .not_attempted {
            background-color: white;
        }

        .popup {
            display: none;
            position: fixed;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            padding: 20px;
            background: white;
            box-shadow: 0px 4px 4px 0px #00000040;
        }

        .popup.show {
            display: block;
        }

        .scrollable-list {
            max-height: 380px;
            overflow-y: auto;
            padding: 0 20px;
            width: 100%;
            margin-right: 50px;

            scroll-behavior: smooth;
        }

        .scrollable-list div {
            margin: 4px 0;
        }

        .scrollable-list::-webkit-scrollbar {
            width: 4px;
            /* Width of the scrollbar */
        }

        .scrollable-list::-webkit-scrollbar-track {
            background: white;
            /* Background of the scrollbar track */
        }

        .scrollable-list::-webkit-scrollbar-thumb {
            background: #0EC1DD;
            /* Color of the scrollbar handle */
            border-radius: 10px;
            /* Roundness of the scrollbar handle */
        }

        .scrollable-list::-webkit-scrollbar-thumb:hover {
            background: #067E90;
            /* Color of the scrollbar handle on hover */
        }
    body,
    .font-sans {
        font-family: 'Inter', sans-serif !important;
    }
</style>
</head>

<body class="font">

    {% include 'Test.html' %}

    <script>
        function getQuestionData() {
            // Retrieve data from localStorage
            const selectedOptions = localStorage.getItem('selectedOptions');
            const selectedOptionsForq_id = localStorage.getItem('selectedOptionsForq_id');
            const questionStatus = localStorage.getItem('questionStatus');
            const attemptIdElement = document.getElementById('submitConfirmationModal');
            const attempt_id = attemptIdElement.dataset.attemptId;

            // Get all questions and their IDs
            const questions = document.querySelectorAll('.question-item');
            const allQuestionIds = Array.from(questions).map(item => item.querySelector('.question_id').textContent);

            // Parse selected options for q_id
            const selectedOptionsForq_id_parsed = JSON.parse(selectedOptionsForq_id) || {};
            allQuestionIds.forEach(q_id => {
                if (!selectedOptionsForq_id_parsed.hasOwnProperty(q_id)) {
                    selectedOptionsForq_id_parsed[q_id] = [];
                }
            });

            // Create q_id to q_order mapping
            let q_id_to_q_order = {};
            questions.forEach((question, index) => {
                const q_id = question.querySelector('.question_id').textContent;
                q_id_to_q_order[q_id] = index + 1; // q_order is 1-based index
            });

            // Return all relevant data
            return {
                selectedOptions,
                selectedOptionsForq_id_parsed,
                questionStatus,
                attempt_id,
                allQuestionIds,
                q_id_to_q_order
            };
        }

        document.addEventListener('DOMContentLoaded', (event) => {
            document.getElementById('confirmSubmit').addEventListener('click', function (event) {
                window.removeEventListener('beforeunload', handleBeforeUnload);

                testdata = getQuestionData();

                const data = {
                    selectedOptions: testdata.selectedOptions,
                    selectedOptionsForq_id: testdata.selectedOptionsForq_id_parsed,
                    questionStatus: testdata.questionStatus,
                    // timeLeft: timeLeft,
                    qIdToQOrder: testdata.q_id_to_q_order,
                    attempt_id: testdata.attempt_id,
                    partial_complete: false
                };

                localStorage.clear();
                // console.log(data)

                fetch('/SubmitCustomModule', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify(data)
                })
                    .then(response => response.json())
                    .then(data => {
                        // console.log('Success:', data);

                        // Assuming `attempt_id` is part of the response
                        const attemptId = data.attempt_id;

                        // Dynamically create a form to submit to Report
                        const form = document.createElement('form');
                        form.method = 'POST';
                        form.action = '/CustomModuleReport';
                        form.target = '_blank'; // Open in a new tab

                        // Add attempt_id as a hidden input
                        const input = document.createElement('input');
                        input.type = 'hidden';
                        input.name = 'attempt_id';
                        input.value = attemptId;

                        form.appendChild(input);
                        document.body.appendChild(form);
                        form.submit(); // Submit the form
                        window.location.href = "/CustomModuleDashboard";
                    })
                    .catch((error) => {
                        // console.error('Error:', error);
                    });
            });
        });

        function handleBeforeUnload(event) {
            event.preventDefault();
            // console.log("Here doing refresh");

            testdata = getQuestionData();

            const data = {
                selectedOptions: testdata.selectedOptions,
                selectedOptionsForq_id: testdata.selectedOptionsForq_id_parsed,
                questionStatus: testdata.questionStatus,
                // timeLeft: timeLeft,
                qIdToQOrder: testdata.q_id_to_q_order,
                attempt_id: testdata.attempt_id,
                partial_complete: true
            };

            localStorage.clear();
            // console.log(data)

            fetch('/SubmitCustomModule', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json'
                },
                body: JSON.stringify(data)
            }).then(response => {
                if (!response.ok) {
                    // console.error('HTTP error! status:', response.status);
                }
            }).catch(error => {
                // console.error('Fetch error:', error);
            });
        }

        window.addEventListener('beforeunload', handleBeforeUnload);

    </script>

    {% with messages = get_flashed_messages(with_categories=true) %}
    {% if messages %}
    <script>
        {% for category, message in messages %}
        alert("{{ message | escape }}");
        {% endfor %}
    </script>
    {% endif %}
    {% endwith %}
</body>

</html>
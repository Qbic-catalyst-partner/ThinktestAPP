<!-- Profile.html -->
<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Exam Info Dashboard</title>
    <!-- Tailwind CDN and font config -->
    <script>
        tailwind.config = {
            theme: {
                extend: {
                    fontFamily: {
                        sans: ['Inter', 'sans-serif'],
                    },
                },
            },
        }
    </script>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://checkout.razorpay.com/v1/checkout.js"></script>
    <link rel="stylesheet" href="../static/css/index.css" />
    <!-- Font -->
    <link rel="preconnect" href="https://fonts.googleapis.com" />
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin />
    <link rel="stylesheet" href="https://unpkg.com/@material-tailwind/html@latest/styles/material-tailwind.css" />
    <link href="https://cdn.jsdelivr.net/npm/flowbite@2.4.1/dist/flowbite.min.css" rel="stylesheet" />
    <link href="https://cdn.jsdelivr.net/npm/flowbite@2.5.1/dist/flowbite.min.css" rel="stylesheet" />
    <!-- script -->
    <link rel="stylesheet" href="https://unpkg.com/@material-tailwind/html@latest/styles/material-tailwind.css" />
    <script src="https://unpkg.com/@material-tailwind/html@latest/scripts/script-name.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/apexcharts"></script>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@100..900&display=swap" rel="stylesheet" />
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0-beta3/css/all.min.css" />
</head>

<body class="font-[Inter] bg-gray-50">
    <div class="flex flex-row h-screen w-[100vw]">
        <!-- Navbar section -->

        {% include 'SideNavBar.html' %}

        <!-- Main Content Section -->
        <section id="main-content"
            class="flex-1 overflow-auto p-4 transition-all duration-300 ease-in-out text-gray-700 body-font mt-16">

            <!-- Subscription & Renew Plan -->
            <div
                class="container p-4 flex items-center justify-between rounded-lg shadow-md border-l-4 border-cyan-500">
                <p class="text-gray-700">
                    Your subscription ends on <span class="font-semibold">{{ last_subscription_date.strftime('%d %B %Y')
                        if subscription else 'N/A' }}</span>
                </p>
                {% set today = current_date or datetime.utcnow().date() %}
                {% if (last_subscription_date - today).days <= 30 %} <a href="" id="renew-plan-btn"
                    class="bg-cyan-500 hover:bg-cyan-600 text-white px-4 py-2 rounded-md text-sm">
                    Renew Plan
                    </a>
                    {% endif %}
            </div>

            <!-- Profile Section -->

            <div class="container mt-4 rounded-lg shadow-md">
                <div class="py-4 bg-gradient-to-r rounded-t-lg from-cyan-500"></div>

                <div class="container py-4 px-16 flex items-center justify-between gap-4">
                    <p class="text-cyan-500 text-xl font-semibold">
                        Profile
                    </p>
                    <!-- Buttons -->
                    <div class="flex justify-end space-x-4 mt-4">
                        <button id="changePasswordBtn"
                            class="border border-cyan-500 text-cyan-500 px-4 py-2 rounded">Change Password</button>
                        <button id="editProfileBtn" class="bg-cyan-500 text-white px-4 py-2 rounded">Edit</button>
                        <button id="cancelEditBtn"
                            class="bg-gray-400 text-white px-4 py-2 rounded hidden">Cancel</button>
                    </div>
                </div>

                <div class="p-4 mt-4 flex flex-col lg:flex-row gap-4">

                    <div class="flex flex-col items-center md:w-1/3 space-y-4">
                        <!-- Circular profile image -->
                        <div
                            class="relative w-32 h-32 md:w-64 md:h-64 rounded-full overflow-hidden border-2 border-gray-300">
                            <img id="profilePicPreview"
                                src="{{ profile_pic_url if profile_pic_url else url_for('static', filename='images/staticprofile.png') }}"
                                alt="Profile Picture" class="object-cover w-full h-full">
                        </div>

                        <!-- Open Modal Button -->
                        <button id="openProfilePicModal" type="button" class="bg-cyan-500 text-white px-4 py-2 rounded">
                            Edit
                        </button>
                    </div>

                    <!-- Profile Details -->
                    <div class="mt-6 lg:mt-0 lg:w-2/3 grid grid-cols-1 lg:grid-cols-2 gap-4">
                        <!-- First Name -->
                        <div>
                            <p class="text-gray-700">First Name:</p>
                            <span class="font-semibold block" id="firstNameText">{{ user.first_name }}</span>
                            <input type="text" id="firstName" value="{{ user.first_name }}"
                                class="border p-2 rounded-md hidden w-full" />
                        </div>

                        <!-- Last Name -->
                        <div>
                            <p class="text-gray-700">Last Name:</p>
                            <span class="font-semibold block" id="lastNameText">{{ user.last_name }}</span>
                            <input type="text" id="lastName" value="{{ user.last_name }}"
                                class="border p-2 rounded-md hidden w-full" />
                        </div>

                        <!-- Gender Selection -->
                        <div>
                            <p class="text-gray-700">Gender:</p>
                            <span class="font-semibold block" id="genderText">{{ user.gender }}</span>

                            <select id="gender" class="border p-2 rounded-md hidden w-full">
                                <option value="M" {% if user.gender=="M" %}selected{% endif %}>Male</option>
                                <option value="F" {% if user.gender=="F" %}selected{% endif %}>Female</option>
                            </select>
                        </div>


                        <!-- Date of Birth -->
                        <div>
                            <p class="text-gray-700">Date of Birth:</p>
                            <span class="font-semibold block" id="dobText">
                                {{ user.dob.strftime('%d %B %Y') if user.dob else 'N/A' }}
                            </span>
                            <input type="text" id="dob" value="{{ user.dob }}"
                                class="border p-2 rounded-md hidden w-full" />
                        </div>

                        <!-- Institution Name -->
                        <div>
                            <p class="text-gray-700">Institution Name:</p>
                            <span class="font-semibold block" id="institutionText">{{ institution_name }}</span>
                            <input type="text" id="institution" value="{{ institution_name }}"
                                class="border p-2 rounded-md hidden w-full" />
                        </div>

                        <!-- Enrollment Date -->
                        <div>
                            <p class="text-gray-700">Enrollment Date:</p>
                            <span class="font-semibold block" id="enrollmentText">
                                {{ subscription.start_date.strftime('%d %B %Y') if subscription else 'N/A' }}
                            </span>
                        </div>

                        <!-- Contact Number -->
                        <div>
                            <p class="text-gray-700">Contact Number:</p>
                            <span class="font-semibold block" id="phoneText">{{ user.contact_no }}</span>
                            <input type="text" id="phone" value="{{ user.contact_no }}"
                                class="border p-2 rounded-md hidden w-full" />
                            <button id="sendOtpButton" onclick="sendMobileOtp(event)"
                                class="text-cyan-600 underline mt-2 hidden">Verify</button>
                        </div>

                        <!-- Email Address -->
                        <div>
                            <p class="text-gray-700">Email Address:</p>
                            <span class="font-semibold block">{{ user.email }}</span>
                            <input type="hidden" id="userEmail" value="{{ user.email }}">
                        </div>

                        <!-- Plan Details -->
                        <div>
                            <p class="text-gray-700">Your Plan:</p>
                            <span class="font-semibold block">
                                {% if plan %}
                                {{ plan.plan_name }} - â‚¹{{ plan.cost }}
                                {% else %}
                                No Plan Found
                                {% endif %}
                            </span>
                        </div>

                        <!-- Subscription Status -->
                        <div>
                            <p class="text-gray-700">Status:</p>
                            <span class="font-semibold block">
                                {% if subscription and subscription.status %}
                                Active
                                {% else %}
                                Inactive
                                {% endif %}
                            </span>
                        </div>
                    </div>

                </div>
            </div>

            <!-- Interests section -->

            <div class="container mt-8 rounded-lg shadow-md">
                <p class="text-cyan-500 text-xl font-semibold px-16">
                    Interests
                </p>

                <div class="grid grid-cols-1 md:grid-cols-2 gap-6 p-8">
                    <!-- Exam Interests Dropdown -->
                    <div>
                        <!-- <label class="block text-gray-600 text-sm">Exam Interest</label> -->
                        <select id="examInterestDropdown" class="border p-2 rounded-md w-full" disabled>
                            <option value="">Select Exam Interest</option>
                            {% for exam in exam_list %}
                            <option value="{{ exam }}">{{ exam }}</option>
                            {% endfor %}
                        </select>

                        <!-- Selected Exam Interests -->
                        <div id="selectedExamInterests" class="flex flex-wrap mt-2">
                            {% for exam in selected_exam_interests %}
                            <div class="bg-gray-200 px-3 py-1 m-1 rounded-md flex items-center">
                                {{ exam }}
                                <button type="button" class="ml-2 text-grey-500 text-sm remove-interest hidden"
                                    data-type="exam" data-value="{{ exam }}">âœ•</button>
                            </div>
                            {% endfor %}
                        </div>
                    </div>

                    <!-- Subject Interests Dropdown -->
                    <div>
                        <!-- <label class="block text-gray-600 text-sm">Subject Interest</label> -->
                        <select id="subjectInterestDropdown" class="border p-2 rounded-md w-full" disabled>
                            <option value="">Select Subject Interest</option>
                            {% for subject in subject_list %}
                            <option value="{{ subject }}">{{ subject }}</option>
                            {% endfor %}
                        </select>

                        <!-- Selected Subject Interests -->
                        <div id="selectedSubjectInterests" class="flex flex-wrap mt-2">
                            {% for subject in selected_subject_interests %}
                            <div class="bg-gray-200 px-3 py-1 m-1 rounded-md flex items-center">
                                {{ subject }}
                                <button type="button" class="ml-2 text-grey-500 text-sm remove-interest hidden"
                                    data-type="subject" data-value="{{ subject }}">âœ•</button>
                            </div>
                            {% endfor %}
                        </div>
                    </div>
                </div>

            </div>

            <!-- Phone OTP Modal -->
            <div id="phoneOtpModal"
                class="hidden fixed inset-0 flex items-center justify-center bg-black bg-opacity-50">
                <div class="bg-white p-6 rounded-lg w-80">
                    <h2 class="text-xl font-semibold mb-4">Verify Phone Number</h2>
                    <p>OTP sent to <span id="otpPhoneNumber"></span></p>
                    <input type="text" id="otpInput" class="border p-2 w-full rounded mt-3" placeholder="Enter OTP">
                    <div class="flex justify-end space-x-2 mt-3">
                        <button type="button" onclick="closeOtpModal()" class="px-4 py-2 border rounded">Cancel</button>
                        <button onclick="verifyMobileOTP()"
                            class="px-4 py-2 bg-cyan-500 text-white rounded">Verify</button>
                    </div>
                </div>
            </div>

            <!-- * RESET PWD modal -->
            <div id="reset-pwd-modal"
                class="fixed inset-0 flex items-center justify-center bg-black bg-opacity-50 hidden">
                <div class="bg-white p-8 rounded-lg shadow-lg">
                    <div class="flex flex-col justify-center items-center mb-6">
                        <img class="pb-6" src="{{ url_for('static', filename='images/new-pwd.svg') }}" alt="" width="64"
                            height="64">
                        <h2 class="text-2xl font-semibold pb-2">Change password</h2>
                        <p class="text-gray-600">We recommend change of password every 3 months to ensure security</p>
                    </div>
                    <form id="reset-password-form" action="{{ url_for('reset_password') }}" method="post"
                        class="flex flex-col items-center justify-center">
                        <div class="mb-4">
                            <label for="password" class="block text-lg font-medium text-gray-700">New Password</label>
                            <input type="password" id="password" name="password"
                                class="mt-1 block w-[500px] h-[54px] px-3 py-2 border border-gray-300 rounded-md shadow-sm focus:outline-none focus:ring-blue-500 focus:border-blue-500 sm:text-sm"
                                placeholder="Enter your new password" required>
                        </div>
                        <div class="mb-6">
                            <label for="confirm-password" class="block text-lg font-medium text-gray-700">Confirm
                                Password</label>
                            <input type="password" id="confirm-password" name="confirm-password"
                                class="mt-1 block w-[500px] h-[54px] px-3 py-2 border border-gray-300 rounded-md shadow-sm focus:outline-none focus:ring-blue-500 focus:border-blue-500 sm:text-sm"
                                placeholder="Re-enter your new password" required>
                        </div>
                        <div class="mb-6 flex flex-row justify-evenly space-x-4 w-full">
                            <div class="flex items-center justify-center">
                                <img class="w-[6vw]"
                                    src="{{ url_for('static', filename='images/Profile/pwdLock.svg') }}"
                                    alt="Lock Icon">
                            </div>

                            <div class="flex flex-col items-start justify-center">
                                <p class="text-gray-700 font-medium">Password should have at least</p>
                                <div class="grid grid-cols-2 gap-x-6 text-sm text-gray-600 mt-2">
                                    <ul class="list-disc space-y-1">
                                        <li>1 Upper Case</li>
                                        <li>1 Lower Case</li>
                                        <li>1 Number</li>
                                    </ul>
                                    <ul class="list-disc space-y-1">
                                        <li>1 Special Character</li>
                                        <li>Min Size 8 Characters</li>
                                        <li>Max. 18 Characters</li>
                                    </ul>
                                </div>
                            </div>
                        </div>
                        <div class="flex justify-evenly pt-2 w-full">
                            <button type="button" id="cancel-reset-btn"
                                class="py-2 px-4 border border-gray-300 rounded-md shadow-sm text-l font-medium text-gray-700 bg-white border-2 border-sky-300"
                                style="width:200px; height: 46px;">Cancel</button>
                            <button type="submit" id="update-password-btn"
                                class="py-2 mr-8 px-4 border border-transparent rounded-md shadow-sm text-l font-medium text-white bg-blue-600 hover:bg-blue-700 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-blue-500"
                                style="width:200px; height: 46px; background-color: var(--links-color);">Update
                                Password</button>
                        </div>
                    </form>
                </div>
            </div>

            <!-- RESET PWD SUCCESS modal -->
            <div id="success-rest-pwd-modal"
                class="fixed inset-0 flex items-center justify-center bg-black bg-opacity-50 hidden">
                <div class="bg-white p-8 rounded-lg shadow-lg w-[80%] md:w-[35%]">
                    <div class="text-center mb-6">
                        <img src="{{ url_for('static', filename='images/tick.svg') }}" alt="Success" width="95"
                            height="95">
                        <h2 class="text-2xl font-semibold pb-2">Successful</h2>
                        <p class="text-gray-600">Your Password has been updated!</p>
                    </div>
                    <div class="flex justify-center pt-8 pb-4">
                        <button id="close-success-modal-btn" type="button"
                            class="py-2 px-4 border border-gray-300 rounded-md shadow-sm text-l font-medium text-gray-700 bg-white border-2 border-sky-300"
                            style="width:200px; height: 46px; color: var(--links-color);">Back</button>
                    </div>
                </div>
            </div>

            <!-- Purchase Plan Modal -->
            <div id="purchase-plan-modal"
                class="fixed inset-0 flex items-center justify-center bg-black bg-opacity-50 hidden">
                <div
                    class="flex flex-col items-center justify-center bg-white p-8 rounded-lg shadow-lg w-[80%] md:w-[35%]">
                    <div class="text-center mb-6 text-[#343434]">
                        <h2 class="font-bold pb-2">Renew Your Plan</h2>
                        <p class="text-gray-600 px-12">
                            {% if subscription and subscription.end_date < current_date %} Your subscription expired on
                                {% else %} Your subscription will expire on {% endif %} {{
                                subscription.end_date.strftime('%d %B %Y') if subscription else 'N/A' }} <br>
                                Please select a plan to continue
                        </p>
                    </div>
                    <div class="text-left px-28 py-4">
                        {% for plan in plans %}
                        {% if plan.cost != 0 %}
                        <label class="block mb-4">
                            <input type="radio" name="plan" class="mr-2" data-amount="{{ plan.cost|int * 100 }}"
                                data-desc="{{ plan.name }}" data-plan-id="{{ plan.id }}">
                            {{ plan.name }} - â‚¹{{ "{:,.2f}".format(plan.cost) }}
                        </label>
                        {% endif %}
                        {% endfor %}
                    </div>
                    <div id="error-message" class="text-center text-red-500 mb-4 hidden">Please select any one of the
                        above plans to proceed!</div>
                    <div class="flex justify-evenly pt-4 pb-4 w-full">
                        <button type="button" id="cancel-payment-btn"
                            class="py-2 px-4 border border-gray-300 rounded-md shadow-sm text-xl font-medium text-gray-700 bg-white border-2 border-sky-300"
                            style="width:180px; height: 46px; color: #0ABDDB;">Cancel</button>
                        <button id="proceed-to-payment-btn" type="button"
                            class="py-2 px-4 border border-gray-300 rounded-md shadow-sm text-xl font-medium text-white"
                            style="width:180px; height: 46px; background-color: #0ABDDB;">Proceed</button>
                    </div>
                </div>
            </div>

            <!-- Confirm Payment Modal -->
            <div id="confirm-payment-modal"
                class="fixed inset-0 flex items-center justify-center bg-black bg-opacity-50 hidden">
                <div
                    class="flex flex-col items-center justify-center bg-white p-8 rounded-lg shadow-lg w-[50%] md:w-[35%]">
                    <img class="pb-6" src="{{ url_for('static', filename='images/Profile/confirmPayment.svg') }}" alt=""
                        width="64" height="64">
                    <div class="text-center mb-6 text-[#343434]">
                        <h2 class="text-2xl font-bold pb-2">Confirm Payment</h2>
                        <p class="text-gray-600 px-12 text-lg" id="selected-plan-text">
                            You have selected the '3 Months' subscription plan. Click on 'Make Payment' to proceed.
                        </p>
                    </div>

                    <div class="flex justify-evenly pt-4 pb-4 w-full">
                        <button type="button" id="cancel-payment-btn"
                            class="py-2 px-4 border border-gray-300 rounded-md shadow-sm text-xl font-medium text-gray-700 bg-white border-2 border-sky-300"
                            style="width:180px; height: 46px; color: #0ABDDB;">Cancel</button>
                        <button id="confirm-payment-btn" type="button"
                            class="py-2 px-4 border border-gray-300 rounded-md shadow-sm text-xl font-medium text-white"
                            style="width:180px; height: 46px; background-color: #0ABDDB;">Make Payment</button>
                    </div>
                </div>
            </div>

            <!-- Payment Loading Modal -->
            <div id="payment-loading-modal"
                class="fixed inset-0 flex items-center justify-center bg-black bg-opacity-50 hidden z-50">
                <div class="bg-white p-8 rounded-lg shadow-lg flex flex-col items-center justify-center">
                    <img src="{{ url_for('static', filename='images/Profile/paymentLoading.svg') }}" alt="Loading"
                        class="mb-4 animate-spin" width="64" height="64">
                    <h2 class="text-xl font-semibold mb-2">Please Donâ€™t Refresh</h2>
                    <p class="text-gray-600">We are currently processing your payment!</p>
                </div>
            </div>

            <!-- Payment Received Modal -->
            <div id="payment-received-modal"
                class="fixed inset-0 flex items-center justify-center bg-black bg-opacity-50 hidden">
                <div
                    class="flex flex-col items-center justify-center bg-white p-8 rounded-lg shadow-lg w-[50%] md:w-[35%]">
                    <img class="pb-6" src="{{ url_for('static', filename='images/Profile/paymentReceived.svg') }}"
                        alt="" width="64" height="64">
                    <div class="text-center mb-6 text-[#343434]">
                        <h2 class="text-2xl font-bold pb-2">Payment Received</h2>
                        <p class="text-gray-600 px-12 text-lg">
                            We have received your payment. Your subscription is now renewed. Kindly login to access the
                            portal.
                        </p>
                    </div>

                    <div class="pt-4 pb-4">
                        <button type="button"
                            class="py-2 px-4 border border-gray-300 rounded-md shadow-sm text-xl font-medium text-gray-700 bg-white border-2 border-sky-300"
                            style="width:180px; height: 46px; color: #0ABDDB;" onclick="window.location.href='/'">
                            Login
                        </button>
                    </div>
                </div>
            </div>

        </section>
    </div>

    <!-- Modal Overlay -->
    <div id="profilePicModal" class="flex fixed inset-0 z-50 hidden items-center justify-center bg-black bg-opacity-50">
        <div class="bg-white p-6 rounded-lg shadow-lg w-[90%] md:w-[400px] space-y-4 text-center">
            <h2 class="text-xl font-semibold text-gray-700">Update Profile Picture</h2>

            <!-- Form -->
            <form id="uploadForm" action="/uploadProfilePic" method="POST" enctype="multipart/form-data"
                class="flex flex-col items-center space-y-4">
                <input type="hidden" name="student_id" value="{{ user.student_id }}">

                <!-- File input -->
                <input type="file" name="image" accept="image/*" required class="text-sm text-gray-500 file:mr-4 file:py-2 file:px-4 file:rounded-full
                          file:border-0 file:text-sm file:font-semibold file:bg-cyan-50 file:text-cyan-700
                          hover:file:bg-cyan-100">

                <!-- Action Buttons -->
                <div class="flex flex-col space-y-2 w-full">
                    <button type="submit" class="bg-cyan-500 hover:bg-cyan-700 text-white py-2 rounded">
                        Upload
                    </button>
                    <button id="removePicBtn" type="button" class="bg-red-500 text-white py-2 rounded">
                        Remove
                    </button>
                    <button type="button" id="cancelModalBtn" class="border border-gray-400 text-gray-700 py-2 rounded">
                        Cancel
                    </button>
                </div>
            </form>
        </div>
    </div>

    <script>
        // #region renew plan
        document.addEventListener("DOMContentLoaded", function () {
            const purchasePlanModal = document.getElementById("purchase-plan-modal");
            const renewPlanButton = document.getElementById("renew-plan-btn"); // Select the Renew Plan button
            const cancelPaymentBtns = document.querySelectorAll("#cancel-payment-btn");

            const confirmPaymentModal = document.getElementById("confirm-payment-modal");
            const paymentReceivedModal = document.getElementById("payment-received-modal");
            const proceedToPaymentBtn = document.getElementById("proceed-to-payment-btn");
            const confirmPaymentBtn = document.getElementById("confirm-payment-btn");

            // Get error message, plan options, and confirmation text
            const errorMessage = document.getElementById("error-message");
            const planOptions = document.querySelectorAll('input[name="plan"]');
            const selectedPlanText = document.getElementById("selected-plan-text"); // Element in Confirm Payment Modal

            // Function to get the selected plan
            function getSelectedPlan() {
                const selectedPlan = Array.from(planOptions).find(plan => plan.checked);
                return selectedPlan ? selectedPlan.nextSibling.textContent.trim() : null;
            }

            // Show the modal when the "Renew Plan" button is clicked
            renewPlanButton.addEventListener("click", function (event) {
                event.preventDefault();
                purchasePlanModal.classList.remove("hidden");
            });

            // Open Confirm Payment Modal when "Proceed" is clicked in Purchase Plan Modal
            proceedToPaymentBtn.addEventListener("click", function () {
                const selectedPlan = getSelectedPlan();
                if (!selectedPlan) {
                    errorMessage.classList.remove("hidden"); // Show error message
                } else {
                    errorMessage.classList.add("hidden"); // Hide error message

                    // Update Confirm Payment Modal with the selected plan
                    selectedPlanText.textContent = `You have selected the '${selectedPlan}' subscription plan. Click on 'Make Payment' to proceed.`;

                    // Show Confirm Payment Modal
                    purchasePlanModal.classList.add("hidden");
                    confirmPaymentModal.classList.remove("hidden");
                }
            });

            document.getElementById('confirm-payment-btn').addEventListener('click', function () {
                // Hide confirm modal
                document.getElementById('confirm-payment-modal').classList.add('hidden');

                // Show loading modal
                document.getElementById('payment-loading-modal').classList.remove('hidden');

                const name = document.getElementById('firstName').value + ' ' + document.getElementById('lastName').value;
                const email = document.getElementById('userEmail').value;
                const phone = document.getElementById('phone').value;

                // Get selected plan amount and description                
                const selectedRadio = document.querySelector('input[name="plan"]:checked');

                if (!selectedRadio) {
                    document.getElementById('error-message').classList.remove('hidden');
                    return;
                }

                const amount = parseInt(selectedRadio.getAttribute('data-amount')); // in paise
                const description = selectedRadio.getAttribute('data-desc');
                const planId = parseInt(selectedRadio.getAttribute('data-plan-id'));
                const studentId = "{{ user.student_id }}";

                fetch('/create_order', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ amount: amount, email: email })
                })
                    .then(response => response.json())
                    .then(orderData => {
                        const options = {
                            key: "{{ razorpaykey }}",
                            amount: amount,
                            currency: "INR",
                            name: "Thinktests",
                            description: description,
                            order_id: orderData.order_id,
                            handler: function (response) {
                                fetch('/verify_payment', {
                                    method: 'POST',
                                    headers: { 'Content-Type': 'application/json' },
                                    body: JSON.stringify({
                                        razorpay_payment_id: response.razorpay_payment_id,
                                        razorpay_order_id: response.razorpay_order_id,
                                        razorpay_signature: response.razorpay_signature
                                    })
                                })
                                    .then(res => res.json())
                                    .then(data => {
                                        if (data.status === 'success') {
                                            fetch('/renewSubscription', {
                                                method: 'POST',
                                                headers: { 'Content-Type': 'application/json' },
                                                body: JSON.stringify({
                                                    student_id: studentId,
                                                    plan_id: planId
                                                })
                                            })
                                                .then(res => res.json())
                                                .then(data => {
                                                    document.getElementById('payment-loading-modal').classList.add('hidden');
                                                    if (data.status === 'success') {
                                                        document.getElementById('payment-received-modal').classList.remove('hidden');
                                                    } else {
                                                        alert("Subscription renewal failed.");
                                                    }
                                                })
                                                .catch(err => {
                                                    document.getElementById('payment-loading-modal').classList.add('hidden');
                                                    alert("Error renewing subscription.");
                                                });
                                        } else {
                                            alert("Signature verification failed. Please try again.");
                                            document.getElementById('payment-loading-modal').classList.add('hidden');
                                        }
                                    })
                                    .catch(err => {
                                        alert("Verification error. Please try again.");
                                        document.getElementById('payment-loading-modal').classList.add('hidden');
                                    });
                            },
                            modal: {
                                ondismiss: function () {
                                    document.getElementById('payment-loading-modal').classList.add('hidden');
                                },
                                escape: true,
                                backdropclose: true
                            },
                            prefill: {
                                name: name,
                                email: email,
                                contact: phone
                            },
                            theme: {
                                color: "#0ABDDB"
                            }
                        };

                        const rzp = new Razorpay(options);
                        rzp.on('payment.failed', function (response) {
                            alert("Payment failed: " + response.error.description);
                            document.getElementById('payment-loading-modal').classList.add('hidden');
                        });
                        rzp.open();
                    })
                    .catch(err => {
                        alert("Unable to initiate payment. Please try again.");
                        document.getElementById('payment-loading-modal').classList.add('hidden');
                    });
            });


            // Close any modal when clicking "Cancel"
            cancelPaymentBtns.forEach(button => {
                button.addEventListener("click", function () {
                    purchasePlanModal.classList.add("hidden");
                    confirmPaymentModal.classList.add("hidden");
                    paymentReceivedModal.classList.add("hidden");
                });
            });

            // Close modal when clicking outside of it
            window.addEventListener("click", function (event) {
                if (event.target === purchasePlanModal) {
                    purchasePlanModal.classList.add("hidden");
                    errorMessage.classList.add("hidden");
                }
                if (event.target === confirmPaymentModal) {
                    confirmPaymentModal.classList.add("hidden");
                }
                if (event.target === paymentReceivedModal) {
                    paymentReceivedModal.classList.add("hidden");
                }
            });
        });
        // #endregion

        // #region change password
        var password = document.getElementById("password")
        var confirm_password = document.getElementById("confirm-password");

        function validatePassword() {
            if (password.value != confirm_password.value) {
                confirm_password.setCustomValidity("Passwords Don't Match");
            } else {
                confirm_password.setCustomValidity('');
            }
        }

        password.onchange = validatePassword;
        confirm_password.onkeyup = validatePassword;

        document.addEventListener("DOMContentLoaded", function () {
            const changePasswordLink = document.getElementById("changePasswordBtn");
            const resetPwdModal = document.getElementById("reset-pwd-modal");
            const resetPasswordForm = document.getElementById("reset-password-form");

            // Close the modal on 'cancel' button click     
            document.getElementById('cancel-reset-btn').addEventListener('click', function () {
                resetPwdModal.classList.add('hidden');
            });

            // Show the forgot password modal
            changePasswordLink.addEventListener("click", function (event) {
                event.preventDefault();
                resetPwdModal.classList.remove("hidden");
            });

            // Close the modal when clicking outside of it
            window.addEventListener("click", function (event) {
                if (event.target === resetPwdModal) {
                    resetPwdModal.classList.add("hidden");
                }
            });

            // Handle the reset password form submission
            resetPasswordForm.addEventListener("submit", function (event) {
                event.preventDefault();
                const email = document.getElementById("userEmail").value;
                const password = document.getElementById("password").value;

                fetch("/reset_password", {
                    method: "POST",
                    headers: {
                        "Content-Type": "application/json"
                    },
                    body: JSON.stringify({ email: email, password: password })
                })
                    .then(response => response.json())
                    .then(data => {
                        if (data.success) {
                            //alert("Password updated successfully!");
                            document.getElementById("success-rest-pwd-modal").classList.remove("hidden");
                            resetPwdModal.classList.add("hidden");
                        }
                        else if (data.message) {
                            alert(data.message);
                        }
                        else {
                            alert("Error updating password. Please logout and try again.");
                        }
                    })
                    .catch(error => {
                        // console.error("Error:", error);
                        alert("An unexpected error occurred. Please try again.");
                    });
            });

            // Close the success modal on 'Back' button click     
            document.getElementById('close-success-modal-btn').addEventListener('click', function () {
                var modal = document.getElementById('success-rest-pwd-modal');
                modal.classList.add('hidden');
            });
        });

        // #endregion

        // #region profile

        document.getElementById("editProfileBtn").addEventListener("click", function () {

            let isEditing = this.textContent === "Save";
            this.textContent = isEditing ? "Edit" : "Save";


            if (isEditing) {
                saveProfileData();
            }
            else {
                // Toggle "Cancel" button visibility
                let cancelBtn = document.getElementById("cancelEditBtn");
                cancelBtn.classList.toggle("hidden", isEditing);

                // Toggle between text display and input fields
                // let fields = ["firstName", "lastName", "gender", "dob", "institution", "phone"];
                let fields = ["firstName", "lastName", "gender", "dob", "phone"];
                fields.forEach(field => {
                    let input = document.getElementById(field);
                    let text = document.getElementById(field + "Text");

                    if (input && text) {
                        if (isEditing) {
                            text.classList.remove("hidden");
                            input.classList.add("hidden");
                            input.value = text.textContent.trim(); // Reset input value to original
                        } else {
                            text.classList.add("hidden");
                            input.classList.remove("hidden");

                            // Special handling for DOB: Show calendar input
                            if (field === "dob") {
                                input.type = "date"; // Change input type to date
                                let dobText = text.textContent.trim();
                                if (dobText !== "N/A") {
                                    let formattedDate = formatDateToYYYYMMDD(dobText);
                                    input.value = formattedDate;
                                }
                            }
                        }
                    }
                });

                // Show "Verify" button for phone only when editing
                let verifyButton = document.getElementById("sendOtpButton");
                if (verifyButton) {
                    verifyButton.classList.toggle("hidden", isEditing);
                }

                // Enable/disable dropdowns
                document.getElementById("examInterestDropdown").disabled = !document.getElementById("examInterestDropdown").disabled;
                document.getElementById("subjectInterestDropdown").disabled = !document.getElementById("subjectInterestDropdown").disabled;

                document.querySelectorAll(".remove-interest").forEach(button => {
                    button.classList.toggle("hidden");
                });

            }
        });

        function saveProfileData() {
            let profileData = {
                first_name: document.getElementById("firstName").value,
                last_name: document.getElementById("lastName").value,
                gender: document.getElementById("gender").value,
                dob: document.getElementById("dob").value,
                institution: document.getElementById("institution").value,
                phone: document.getElementById("phone").value,
                exam_interests: getSelectedInterests("selectedExamInterests"),
                subject_interests: getSelectedInterests("selectedSubjectInterests"),
            };

            fetch("/saveprofile", {
                method: "POST",
                headers: {
                    "Content-Type": "application/json",
                },
                body: JSON.stringify(profileData),
            })
                .then(response => response.json())
                .then(data => {
                    if (data.success) {
                        alert("Profile updated successfully!");
                        location.reload(); // Refresh to show updated data
                    } else {
                        alert("Error updating profile. Please try again.");
                    }
                })
                .catch(error => {
                    // console.error("Error:", error);
                });
        }

        function getSelectedInterests(containerId) {
            let selectedInterests = [];
            document.querySelectorAll(`#${containerId} div`).forEach(div => {
                let text = div.childNodes[0].textContent.trim();
                if (text) {
                    selectedInterests.push(text);
                }
            });
            return selectedInterests.join(", ");
        }

        // Cancel Button: Revert to original state
        document.getElementById("cancelEditBtn").addEventListener("click", function () {
            let editBtn = document.getElementById("editProfileBtn");
            editBtn.textContent = "Edit"; // Reset button text

            // Hide "Cancel" button
            this.classList.add("hidden");

            // Reset input fields & show original text
            let fields = ["firstName", "lastName", "gender", "dob", "institution", "phone"];
            fields.forEach(field => {
                let input = document.getElementById(field);
                let text = document.getElementById(field + "Text");

                if (input && text) {
                    text.classList.remove("hidden");
                    input.classList.add("hidden");
                    input.value = text.textContent; // Restore original value

                    // Special handling for DOB: Restore original format
                    if (field === "dob") {
                        input.type = "text"; // Change back to text if canceled
                    }
                }
            });

            // Hide the "Verify" button for phone
            let verifyButton = document.getElementById("sendOtpButton");
            if (verifyButton) {
                verifyButton.classList.add("hidden");
            }

            // Disable dropdowns and remove buttons
            document.getElementById("examInterestDropdown").setAttribute("disabled", true);
            document.getElementById("subjectInterestDropdown").setAttribute("disabled", true);
            document.querySelectorAll(".remove-interest").forEach(btn => btn.classList.add("hidden"));
        });

        // Function to format 'DD Month YYYY' (e.g., 15 August 1995) to 'YYYY-MM-DD' for date input
        function formatDateToYYYYMMDD(dateString) {
            const months = {
                "January": "01", "February": "02", "March": "03", "April": "04",
                "May": "05", "June": "06", "July": "07", "August": "08",
                "September": "09", "October": "10", "November": "11", "December": "12"
            };
            let parts = dateString.split(" ");
            if (parts.length === 3) {
                let day = parts[0].padStart(2, "0"); // Ensure two-digit day
                let month = months[parts[1]]; // Convert month name to number
                let year = parts[2];
                return `${year}-${month}-${day}`;
            }
            return ""; // Return empty if parsing fails
        }

        function sendMobileOtp(event) {
            event.preventDefault();
            const phone = document.getElementById("phone").value;

            fetch("/sendMobileOTP", {
                method: "POST",
                headers: { "Content-Type": "application/json" },
                body: JSON.stringify({ phone: phone })
            })
                .then(response => response.json())
                .then(data => {
                    if (data.success) {
                        document.getElementById("otpPhoneNumber").textContent = phone;
                        document.getElementById("phoneOtpModal").classList.remove("hidden");
                    } else {
                        alert("Failed to send OTP. Try again.");
                    }
                })
        }

        function verifyMobileOTP() {
            const otp = document.getElementById("otpInput").value;
            const phone = document.getElementById("otpPhoneNumber").textContent;

            fetch("/verifyMobileOTP", {
                method: "POST",
                headers: { "Content-Type": "application/json" },
                body: JSON.stringify({ phone: phone, otp: otp })
            })
                .then(response => response.json())
                .then(data => {
                    if (data.success) {
                        alert("Phone Verified Successfully!");
                        closeOtpModal();
                    } else {
                        alert("Invalid OTP. Try again.");
                    }
                })
        }

        function closeOtpModal() {
            document.getElementById("phoneOtpModal").classList.add("hidden");
        }

        //For subject and exam interests
        // Function to add selected interests
        function addInterest(type) {
            let dropdown = document.getElementById(type + "InterestDropdown");
            let selectedValue = dropdown.value;
            if (!selectedValue) return;

            let container = document.getElementById("selected" + type.charAt(0).toUpperCase() + type.slice(1) + "Interests");

            // Prevent duplicate entries
            if (container.innerHTML.includes(selectedValue)) return;

            let interestDiv = document.createElement("div");
            interestDiv.className = "bg-gray-200 px-3 py-1 m-1 rounded-md flex items-center";
            interestDiv.innerHTML = `${selectedValue} 
            <button type="button" class="ml-2 text-grey-500 text-sm remove-interest" data-type="${type}" data-value="${selectedValue}">âœ•</button>`;

            container.appendChild(interestDiv);
            dropdown.value = "";
        }

        document.getElementById("examInterestDropdown").addEventListener("change", function () {
            addInterest("exam");
        });

        document.getElementById("subjectInterestDropdown").addEventListener("change", function () {
            addInterest("subject");
        });

        document.addEventListener("click", function (event) {
            if (event.target.classList.contains("remove-interest")) {
                event.target.parentElement.remove();
            }
        });

        // Profile pic scripts

        document.getElementById("openProfilePicModal").addEventListener("click", () => {
            document.getElementById("profilePicModal").classList.remove("hidden");
        });

        document.getElementById("cancelModalBtn").addEventListener("click", () => {
            document.getElementById("profilePicModal").classList.add("hidden");
        });

        document.getElementById("removePicBtn").addEventListener("click", function () {
            const studentId = "{{ user.student_id }}";

            if (!confirm("Are you sure you want to remove the profile picture?")) return;

            fetch(`/deleteProfilePic/${studentId}`, { method: 'DELETE' })
                .then(response => response.json())
                .then(data => {
                    if (data.success) {
                        document.getElementById("profilePicPreview").src = "{{ url_for('static', filename='images/staticprofile.png') }}";
                        document.getElementById("profilePicModal").classList.add("hidden");
                        alert("Profile picture removed.");
                    } else {
                        alert("Failed to remove profile picture.");
                    }
                })
                .catch(error => {
                    // console.error("Error:", error);
                    alert("Error occurred while deleting.");
                });
        });
    </script>

</body>

</html>